<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Caixa</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Estilos CSS integrados -->
    <style>
        /* Custom scrollbar for better mobile look */
        ::-webkit-scrollbar {
            width: 0;
            height: 0;
            background: transparent;
        }
        /* Style for the card carousel on mobile */
        .snap-x {
            scroll-snap-type: x mandatory;
        }
        .snap-center {
            scroll-snap-align: center;
        }
        /* Ensure the app has a fixed height on mobile */
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita o scroll do body principal em alguns celulares */
        }
        main {
            /* The main content area will scroll between the fixed header and footer */
            overflow-y: auto;
            height: 100%; /* Garante que o main ocupe toda a altura disponível */
            position: relative; /* Ajuda a resolver problemas de sobreposição */
        }
        .subsector-button {
            transition: background-color 0.2s, transform 0.2s;
        }
        .subsector-button:active {
            transform: scale(0.98);
            background-color: #f0f0f0; /* a light gray for feedback */
        }

        /* Styling for the investment source list */
        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* --- History Page & Standard Card Styles --- */
        .history-item, .project-card, .sector-card {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .history-item {
             border-left-width: 5px;
        }

        .project-card, .sector-card {
            border-top-width: 5px;
        }

        .history-item-revenue, .card-positive {
            border-color: #22c55e; /* green-500 */
        }

        .history-item-cost, .card-negative {
            border-color: #ef4444; /* red-500 */
        }

        .card-neutral {
             border-color: #f59e0b; /* amber-500 */
        }

        /* --- Chart Card Styles (Updated) --- */
        .chart-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            height: 280px; /* Altura fixa para consistência, um pouco menor */
            display: flex;
            flex-direction: column;
        }

        .chart-card h2, .chart-card h3 {
            text-align: center;
            font-weight: bold;
            margin-bottom: 0.5rem; /* Menor margem */
            flex-shrink: 0;
            color: #374151; /* gray-700 */
            font-size: 1rem; /* Fonte um pouco menor */
        }

        .chart-card canvas {
            flex-grow: 1;
            min-height: 0;
        }

        /* --- Sector Card Color Styles --- */
        .sector-card-financeiro {
            border-color: #ef4444; /* red-500 */
        }
        .sector-card-operacional {
            border-color: #f59e0b; /* amber-500 */
        }
        .sector-card-comercial {
            border-color: #22c55e; /* green-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Top Header: Total Balance (Fixed) -->
    <header class="fixed top-0 left-0 right-0 bg-white p-4 shadow-md z-10">
        <h2 class="text-sm font-medium text-gray-500">Saldo Total Consolidado</h2>
        <p id="total-balance" class="text-3xl font-bold text-gray-900">R$ 0,00</p>
    </header>

    <!-- Main Content Area (with padding to avoid overlap) -->
    <main class="pt-24 pb-20 md:pt-28">
        <!-- Home Page View -->
        <div id="home-view">
            <div class="p-6 max-w-7xl mx-auto">
                <h1 class="text-2xl font-bold mb-4">Meus Projetos</h1>
                <!-- Project Carousel/Grid -->
                <div id="project-carousel" class="flex overflow-x-auto gap-4 snap-x pb-4 md:grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 md:overflow-visible">
                    <!-- Projects will be inserted here by JS -->
                </div>
            </div>

            <!-- Investment Sources List -->
            <div id="investment-sources-list-container" class="p-6 max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold mb-4">Fontes de Investimento</h2>
                <div id="investment-sources-list" class="space-y-3">
                    <!-- Source items will be inserted here by JS -->
                </div>
            </div>
        </div>

        <!-- Sectors Page View -->
        <div id="sectors-view" class="hidden p-6 max-w-7xl mx-auto">
            <div class="flex items-center mb-4 relative">
                 <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                 </button>
                 <h1 id="sectors-project-name" class="text-2xl font-bold w-full text-center">Nome do Projeto</h1>
            </div>
            <p class="text-center text-gray-500 mb-6">Selecione uma ação ou subsetor.</p>
            <div class="flex overflow-x-auto gap-4 snap-x pb-4 md:grid md:grid-cols-3 md:overflow-visible">
                <!-- Sector Cards with Subsectors -->
                <div class="sector-card sector-card-financeiro flex-shrink-0 w-full max-w-xs md:max-w-none mx-auto bg-white rounded-xl shadow-lg flex flex-col p-4 snap-center">
                    <div class="flex items-center mb-4">
                        <h3 class="text-xl font-bold">Financeiro</h3>
                    </div>
                    <div id="financeiro-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2">
                        <!-- Indicators will be injected here by JS -->
                    </div>
                    <div class="flex-grow space-y-2 flex flex-col justify-center">
                       <button onclick="openInvestmentModal()" class="subsector-button w-full text-left p-3 rounded-lg border">Investimento</button>
                       <button onclick="openTransactionModal('Financeiro', 'Planejamento')" class="subsector-button w-full text-left p-3 rounded-lg border">Planejamento</button>
                       <button onclick="openTransactionModal('Financeiro', 'Recursos')" class="subsector-button w-full text-left p-3 rounded-lg border">Recursos</button>
                    </div>
                </div>

                <div class="sector-card sector-card-operacional flex-shrink-0 w-full max-w-xs md:max-w-none mx-auto bg-white rounded-xl shadow-lg flex flex-col p-4 snap-center">
                     <div class="flex items-center mb-4">
                        <h3 class="text-xl font-bold">Operacional</h3>
                    </div>
                    <div id="operacional-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2">
                        <!-- Indicators will be injected here by JS -->
                    </div>
                    <div class="flex-grow space-y-2 flex flex-col justify-center">
                       <button onclick="openTransactionModal('Operacional', 'Treinamento')" class="subsector-button w-full text-left p-3 rounded-lg border">Treinamento</button>
                       <button onclick="openTransactionModal('Operacional', 'Armazenamento')" class="subsector-button w-full text-left p-3 rounded-lg border">Armazenamento</button>
                       <button onclick="openTransactionModal('Operacional', 'Produção')" class="subsector-button w-full text-left p-3 rounded-lg border">Produção</button>
                    </div>
                </div>

                <div class="sector-card sector-card-comercial flex-shrink-0 w-full max-w-xs md:max-w-none mx-auto bg-white rounded-xl shadow-lg flex flex-col p-4 snap-center">
                    <div class="flex items-center mb-4">
                        <h3 class="text-xl font-bold">Comercial</h3>
                    </div>
                     <div id="comercial-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2">
                        <!-- Indicators will be injected here by JS -->
                    </div>
                     <div class="flex-grow space-y-2 flex flex-col justify-center">
                       <button onclick="openTransactionModal('Comercial', 'Marketing')" class="subsector-button w-full text-left p-3 rounded-lg border">Marketing</button>
                       <button onclick="openTransactionModal('Comercial', 'Relacionamento')" class="subsector-button w-full text-left p-3 rounded-lg border">Relacionamento</button>
                       <button onclick="openTransactionModal('Comercial', 'Vendas')" class="subsector-button w-full text-left p-3 rounded-lg border">Vendas</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard/Results Page View (For Projects) -->
        <div id="project-dashboard-view" class="hidden p-6 max-w-7xl mx-auto">
             <div class="flex items-center mb-4 relative">
                 <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                 </button>
                 <h1 class="text-2xl font-bold w-full text-center">Resultados dos Projetos</h1>
             </div>
             <div class="flex justify-center gap-2 mb-2">
                 <button onclick="filterDashboardCharts('week')" data-period="week" class="dashboard-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Semana</button>
                 <button onclick="filterDashboardCharts('month')" data-period="month" class="dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Mês</button>
                 <button onclick="filterDashboardCharts('year')" data-period="year" class="dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Ano</button>
             </div>
             <div class="flex justify-center gap-2 mb-4 border-t pt-4 mt-4">
                 <button onclick="filterDashboardView('bars')" data-view="bars" class="dashboard-view-btn view-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Barras</button>
                 <button onclick="filterDashboardView('pizza')" data-view="pizza" class="dashboard-view-btn view-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Pizza</button>
             </div>
             <!-- Charts Container for projects -->
             <div id="project-charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Pie charts and bar charts for projects will be injected here -->
             </div>
        </div>
        
        <!-- Dashboard/Results Page View (For Sectors) -->
        <div id="sector-dashboard-view" class="hidden p-6 max-w-7xl mx-auto">
             <div class="flex items-center mb-4 relative">
                 <button onclick="switchView('sectors-view', currentProjectId)" class="absolute left-0 p-2 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                 </button>
                 <h1 class="text-2xl font-bold w-full text-center">Resultados dos Setores</h1>
             </div>
              <div class="flex justify-center gap-2 mb-2">
                 <button onclick="filterSectorDashboardCharts('week')" data-period="week" class="sector-dashboard-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Semana</button>
                 <button onclick="filterSectorDashboardCharts('month')" data-period="month" class="sector-dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Mês</button>
                 <button onclick="filterSectorDashboardCharts('year')" data-period="year" class="sector-dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Ano</button>
             </div>
              <div class="flex justify-center gap-2 mb-4 border-t pt-4 mt-4">
                 <button onclick="filterSectorView('bars')" data-view="bars" class="sector-view-btn view-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Barras</button>
                 <button onclick="filterSectorView('pizza')" data-view="pizza" class="sector-view-btn view-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Pizza</button>
             </div>
             <!-- Charts Container for subsectors -->
             <div id="sector-charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bar charts for subsectors will be injected here -->
             </div>
        </div>

        <!-- History Page View -->
        <div id="history-view" class="hidden p-6 max-w-7xl mx-auto">
            <div class="flex items-center mb-4 relative">
                <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                   </svg>
                </button>
                <h1 class="text-2xl font-bold w-full text-center">Histórico</h1>
            </div>
            <!-- Filters -->
            <div id="history-filters" class="mb-4 space-y-3 bg-white p-3 rounded-xl shadow">
                <div class="flex justify-center gap-2">
                     <button onclick="filterHistoryPeriod('week')" data-period="week" class="history-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold flex-1">Semana</button>
                     <button onclick="filterHistoryPeriod('month')" data-period="month" class="history-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold flex-1">Mês</button>
                     <button onclick="filterHistoryPeriod('year')" data-period="year" class="history-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold flex-1">Ano</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="sector-filter" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></select>
                    <select id="subsector-filter" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></select>
                </div>
            </div>
            <!-- History List -->
            <div id="history-list" class="space-y-3">
                <!-- History items will be inserted here by JS -->
            </div>
       </div>

    </main>

    <!-- Bottom Navigation Bar (Fixed) -->
    <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 p-2 flex justify-around items-center z-10">
        <!-- Home Page Navigation -->
        <div id="home-nav" class="w-full flex justify-around items-center">
             <button onclick="switchView('history-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs">Histórico</span>
            </button>
            <button onclick="openModal('project-modal')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-xs">Criar Projeto</span>
            </button>
            <button onclick="showResults()" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-xs">Resultados</span>
            </button>
        </div>
        <!-- Sectors Page Navigation -->
        <div id="sectors-nav" class="w-full flex justify-around items-center hidden">
             <button onclick="switchView('history-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs">Histórico</span>
            </button>
            <button onclick="switchView('home-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 002 2h10a2 2 0 002-2V10M9 20v-6a2 2 0 012-2h2a2 2 0 012 2v6" /></svg>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="showResults()" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-xs">Resultados</span>
            </button>
        </div>
    </footer>

    <!-- Modals -->
    <div id="project-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Novo Projeto</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-gray-600 mb-1">Nome do Projeto</label>
                    <input type="text" id="project-name" placeholder="Ex: Lançamento App Mobile" class="w-full p-2 border border-gray-300 rounded-lg" required>
                </div>
                 <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('project-modal')" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Unificado para Investimento -->
    <div id="investment-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-2">Ação de Investimento</h2>
            <h3 id="investment-project-name" class="text-indigo-600 font-semibold mb-4"></h3>
            <form id="investment-form">
                <div class="mb-4">
                    <label for="investment-action-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo de Ação</label>
                    <select id="investment-action-type" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="source">Fonte de Investimento</option>
                        <option value="cost">Custo</option>
                    </select>
                </div>

                <!-- Fields for a new Source -->
                <div id="investment-source-fields">
                    <div class="mb-4">
                        <label for="inv-source-name" class="block text-sm font-medium text-gray-600 mb-1">Nome da Fonte</label>
                        <input type="text" id="inv-source-name" placeholder="Ex: Investidor Anjo" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="inv-source-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo</label>
                        <select id="inv-source-type" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option>Meu Caixa</option>
                            <option>Investidor Anjo</option>
                            <option>Empréstimo</option>
                            <option>Crédito</option>
                            <option>Corretora</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="inv-source-balance" class="block text-sm font-medium text-gray-600 mb-1">Saldo Inicial</label>
                        <input type="number" id="inv-source-balance" placeholder="1000.00" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <!-- Fields for a Cost Operation -->
                <div id="investment-cost-fields" class="hidden">
                     <div class="mb-4">
                        <label for="inv-cost-description" class="block text-sm font-medium text-gray-600 mb-1">Nome da Operação</label>
                        <input type="text" id="inv-cost-description" placeholder="Ex: Taxa de Abertura" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="inv-cost-date" class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                        <input type="date" id="inv-cost-date" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                     <div class="mb-4">
                        <label for="inv-cost-source" class="block text-sm font-medium text-gray-600 mb-1">Debitar da Fonte</label>
                        <select id="inv-cost-source" class="w-full p-2 border border-gray-300 rounded-lg">
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="inv-cost-amount" class="block text-sm font-medium text-gray-600 mb-1">Valor do Custo</label>
                        <input type="number" id="inv-cost-amount" placeholder="100.00" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('investment-modal')" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Padrão para Outras Transações -->
    <div id="transaction-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-2">Adicionar Operação</h2>
            <h3 id="transaction-project-name" class="text-indigo-600 font-semibold mb-4"></h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-sector">
                <input type="hidden" id="transaction-subsector">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo</label>
                        <select id="transaction-type" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="cost">Custo</option>
                            <option value="revenue">Receita</option>
                        </select>
                    </div>
                     <div>
                        <label for="transaction-date" class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                        <input type="date" id="transaction-date" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="transaction-description" class="block text-sm font-medium text-gray-600 mb-1">Nome da Operação</label>
                    <input type="text" id="transaction-description" placeholder="Ex: Venda de licença" class="w-full p-2 border border-gray-300 rounded-lg" required>
                </div>
                 <div id="transaction-source-wrapper" class="mb-4">
                    <label for="transaction-source" class="block text-sm font-medium text-gray-600 mb-1">Fonte de Investimento</label>
                    <select id="transaction-source" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        <!-- Sources will be populated by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-600 mb-1">Valor</label>
                    <input type="number" id="transaction-amount" placeholder="500.00" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('transaction-modal')" class="px-4 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JavaScript Integrado -->
    <script>
        // --- GERENCIAMENTO DE DADOS ---
        let sources = [];
        let projects = [];
        let activeCharts = []; // Para rastrear e destruir gráficos antigos
        let currentProjectId = null;
        let historyFilters = { period: 'week', sector: 'all', subsector: 'all' };
        let dashboardPeriodFilter = 'week';
        let projectDashboardViewMode = 'bars';
        let sectorDashboardViewMode = 'bars';
        const subsectorsBySector = {
            'all': ['Todos os Subsetores'],
            'Financeiro': ['Todos', 'Investimento', 'Planejamento', 'Recursos'],
            'Operacional': ['Todos', 'Treinamento', 'Armazenamento', 'Produção'],
            'Comercial': ['Todos', 'Marketing', 'Relacionamento', 'Vendas']
        };

        // --- FUNÇÕES UTILITÁRIAS ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        };

        const saveData = () => {
            localStorage.setItem('projectManagerData', JSON.stringify({ sources, projects }));
        };

        const loadData = () => {
            try {
                const data = JSON.parse(localStorage.getItem('projectManagerData'));
                if (data) {
                    sources = data.sources || [];
                    projects = data.projects || [];
                }
            } catch (e) {
                console.error("Erro ao carregar dados. Os dados foram resetados.", e);
                sources = [];
                projects = [];
            }
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO PRINCIPAIS ---
        const renderTotalBalance = () => {
            const total = sources.reduce((sum, source) => sum + parseFloat(source.balance), 0);
            document.getElementById('total-balance').textContent = formatCurrency(total);
        };

        const renderProjects = () => {
            const carousel = document.getElementById('project-carousel');
            carousel.innerHTML = '';

            if (projects.length === 0) {
                carousel.innerHTML = `<div class="project-card flex-shrink-0 w-full max-w-xs mx-auto p-6 snap-center"><div class="flex flex-col items-center justify-center text-center h-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="font-bold text-lg">Nenhum projeto ainda</h3><p class="text-gray-500">Clique em "Criar Projeto" para começar.</p></div></div>`;
                return;
            }

            projects.forEach(project => {
                const totalRevenue = project.transactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = project.transactions.filter(t => t.type === 'cost').reduce((sum, t) => sum + t.amount, 0);
                const projectBalance = totalRevenue - totalCost;

                const card = document.createElement('div');
                let borderColorClass = 'card-neutral';
                if (projectBalance > 0) {
                    borderColorClass = 'card-positive';
                } else if (projectBalance < 0) {
                    borderColorClass = 'card-negative';
                }
                
                card.className = `project-card ${borderColorClass} flex-shrink-0 w-full max-w-xs mx-auto snap-center cursor-pointer hover:shadow-xl transition`;
                card.setAttribute('onclick', `switchView('sectors-view', '${project.id}')`);
                card.innerHTML = `
                    <h3 class="font-bold text-xl text-gray-800 mb-2">${project.name}</h3>
                    <div class="space-y-2 text-sm border-t pt-2 mt-2">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Receita</span>
                            <span class="font-semibold text-green-500">${formatCurrency(totalRevenue)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Custo</span>
                            <span class="font-semibold text-red-500">${formatCurrency(totalCost)}</span>
                        </div>
                        <div class="flex justify-between border-t pt-2 mt-2">
                            <span class="font-bold text-gray-700">Resultado</span>
                            <span class="font-bold ${projectBalance >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(projectBalance)}</span>
                        </div>
                    </div>`;
                carousel.appendChild(card);
            });
        };

        const renderInvestmentSources = () => {
            const list = document.getElementById('investment-sources-list');
            list.innerHTML = '';
            if (sources.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center">Nenhuma fonte de investimento cadastrada.</p>`;
                return;
            }
            sources.forEach(source => {
                const item = document.createElement('div');
                item.className = 'source-item';
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${source.name}</p>
                        <p class="text-sm text-gray-500">${source.type}</p>
                    </div>
                    <p class="font-bold text-lg ${source.balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(source.balance)}</p>
                `;
                list.appendChild(item);
            });
        };

        const renderSectorIndicators = () => {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            ['Financeiro', 'Operacional', 'Comercial'].forEach(sector => {
                const sectorTransactions = project.transactions.filter(t => t.sector === sector);
                const totalRevenue = sectorTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = sectorTransactions.filter(t => t.type === 'cost').reduce((sum, t) => sum + t.amount, 0);
                const result = totalRevenue - totalCost;
                
                const indicatorDiv = document.getElementById(`${sector.toLowerCase()}-indicators`);

                if (indicatorDiv) {
                    indicatorDiv.innerHTML = `
                        <div class="flex justify-between">
                            <span class="text-gray-500">Receita</span>
                            <span class="font-semibold text-green-500">${formatCurrency(totalRevenue)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Custo</span>
                            <span class="font-semibold text-red-500">${formatCurrency(totalCost)}</span>
                        </div>
                         <div class="flex justify-between border-t mt-2 pt-2">
                            <span class="text-gray-700 font-bold">Resultado</span>
                            <span class="font-bold ${result >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(result)}</span>
                        </div>
                    `;
                }
            });
        };


        // --- FUNÇÕES DE GRÁFICOS ---

        const destroyActiveCharts = () => {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
        };

        function createChart(container, title, chartConfig) {
            const card = document.createElement('div');
            card.className = 'chart-card';
            card.innerHTML = `<h2>${title}</h2><canvas></canvas>`;
            container.appendChild(card);
            const canvas = card.querySelector('canvas');
            if (canvas) {
                activeCharts.push(new Chart(canvas.getContext('2d'), chartConfig));
            }
        }

        function renderProjectDashboardCharts(period = 'week') {
            destroyActiveCharts();
            const container = document.getElementById('project-charts-container');
            container.innerHTML = '';

            if (projectDashboardViewMode === 'pizza') {
                const pieData = projects.reduce((acc, project) => {
                    const revenue = project.transactions.filter(t => t.type === 'revenue' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0);
                    const cost = project.transactions.filter(t => t.type === 'cost' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0);
                    if (revenue > 0) { acc.revenues.data.push(revenue); acc.revenues.labels.push(project.name); }
                    if (cost > 0) { acc.costs.data.push(cost); acc.costs.labels.push(project.name); }
                    return acc;
                }, { revenues: { labels: [], data: [] }, costs: { labels: [], data: [] } });

                if (pieData.revenues.data.length > 0) createChart(container, 'Receita por Projeto', { type: 'pie', data: { labels: pieData.revenues.labels, datasets: [{ data: pieData.revenues.data, backgroundColor: ['#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                if (pieData.costs.data.length > 0) createChart(container, 'Custo por Projeto', { type: 'pie', data: { labels: pieData.costs.labels, datasets: [{ data: pieData.costs.data, backgroundColor: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            } else { // 'bars'
                projects.forEach(project => {
                    const data = aggregateDataForPeriod(project.transactions, period);
                    createChart(container, `Desempenho: ${project.name}`, { type: 'bar', data: { labels: data.labels, datasets: [ { label: 'Receita', data: data.revenues, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Custo', data: data.costs, backgroundColor: 'rgba(255, 99, 132, 0.6)' } ] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }});
                });
            }
        }

        function renderSectorDashboardCharts(period = 'week') {
            destroyActiveCharts();
            const container = document.getElementById('sector-charts-container');
            container.innerHTML = '';
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const allSubsectors = ['Investimento', 'Planejamento', 'Recursos', 'Treinamento', 'Armazenamento', 'Produção', 'Marketing', 'Relacionamento', 'Vendas'];

             if (sectorDashboardViewMode === 'pizza') {
                const pieData = allSubsectors.reduce((acc, subsector) => {
                    const revenue = project.transactions.filter(t => t.subSector === subsector && t.type === 'revenue' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0);
                    const cost = project.transactions.filter(t => t.subSector === subsector && t.type === 'cost' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0);
                    if (revenue > 0) { acc.revenues.data.push(revenue); acc.revenues.labels.push(subsector); }
                    if (cost > 0) { acc.costs.data.push(cost); acc.costs.labels.push(subsector); }
                    return acc;
                }, { revenues: { labels: [], data: [] }, costs: { labels: [], data: [] } });

                if (pieData.revenues.data.length > 0) createChart(container, 'Receita por Subsetor', { type: 'pie', data: { labels: pieData.revenues.labels, datasets: [{ data: pieData.revenues.data, backgroundColor: ['#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#795548', '#607D8B', '#009688'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                if (pieData.costs.data.length > 0) createChart(container, 'Custo por Subsetor', { type: 'pie', data: { labels: pieData.costs.labels, datasets: [{ data: pieData.costs.data, backgroundColor: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#f43f5e'] }] }, options: { responsive: true, maintainAspectRatio: false } });

            } else { // 'bars'
                allSubsectors.forEach(subsector => {
                    const transactions = project.transactions.filter(t => t.subSector === subsector && isDateInPeriod(t.date, period));
                    const data = aggregateDataForPeriod(transactions, period);
                    createChart(container, `Desempenho: ${subsector}`, { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Receita', data: data.revenues, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Custo', data: data.costs, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }});
                });
            }
        }

        function isDateInPeriod(dateString, period) {
            const date = new Date(dateString);
            const now = new Date();
            let startDate = new Date();

            if (period === 'week') {
                startDate.setDate(now.getDate() - now.getDay());
                startDate.setHours(0,0,0,0);
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            return date >= startDate;
        }

        function aggregateDataForPeriod(transactions, period) {
            const result = { labels: [], revenues: [], costs: [] };
            const filtered = transactions.filter(t => isDateInPeriod(t.date, period));

            if (period === 'week') {
                result.labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                result.revenues = Array(7).fill(0);
                result.costs = Array(7).fill(0);
                filtered.forEach(t => {
                    const day = new Date(t.date).getUTCDay();
                    if (t.type === 'revenue') result.revenues[day] += t.amount;
                    else result.costs[day] += t.amount;
                });
            } else if (period === 'month') {
                const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                result.labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                result.revenues = Array(daysInMonth).fill(0);
                result.costs = Array(daysInMonth).fill(0);
                 filtered.forEach(t => {
                    const day = new Date(t.date).getUTCDate() - 1;
                    if (t.type === 'revenue') result.revenues[day] += t.amount;
                    else result.costs[day] += t.amount;
                });
            } else { // year
                result.labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                result.revenues = Array(12).fill(0);
                result.costs = Array(12).fill(0);
                 filtered.forEach(t => {
                    const month = new Date(t.date).getUTCMonth();
                    if (t.type === 'revenue') result.revenues[month] += t.amount;
                    else result.costs[month] += t.amount;
                });
            }
            return result;
        }

        // --- CONTROLE DA UI ---
        const openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

        function closeModalOnOutsideClick(event) {
            if (event.target.id.endsWith('-modal')) {
                closeModal(event.target.id);
            }
        }
        
        const openTransactionModal = (sector, subSector) => {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;
            
            const form = document.getElementById('transaction-form');
            form.reset();

            document.getElementById('transaction-project-name').textContent = `${project.name} / ${sector} / ${subSector}`;
            form.elements['transaction-sector'].value = sector;
            form.elements['transaction-subsector'].value = subSector;
            form.elements['transaction-date'].valueAsDate = new Date();

            const sourceSelect = document.getElementById('transaction-source');
            sourceSelect.innerHTML = '';
            if (sources.length === 0) {
                sourceSelect.innerHTML = '<option value="" disabled selected>Nenhuma fonte criada</option>';
            } else {
                sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = `${source.name} (${source.type})`;
                    sourceSelect.appendChild(option);
                });
            }
            
            openModal('transaction-modal');
        };

        const openInvestmentModal = () => {
             const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                alert("Por favor, selecione um projeto na tela inicial antes de realizar uma ação de investimento.");
                return;
            }
            document.getElementById('investment-form').reset();
            document.getElementById('investment-project-name').textContent = `${project.name} / Financeiro / Investimento`;
            
            const sourceSelect = document.getElementById('inv-cost-source');
            sourceSelect.innerHTML = '';
             if (sources.length === 0) {
                sourceSelect.innerHTML = '<option value="" disabled selected>Nenhuma fonte criada</option>';
            } else {
                sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = `${source.name} (${source.type})`;
                    sourceSelect.appendChild(option);
                });
            }
            document.getElementById('inv-cost-date').valueAsDate = new Date();
            updateInvestmentFormUI(); // Set initial state
            openModal('investment-modal');
        }

        const updateInvestmentFormUI = () => {
            const actionType = document.getElementById('investment-action-type').value;
            const sourceFields = document.getElementById('investment-source-fields');
            const costFields = document.getElementById('investment-cost-fields');

            if (actionType === 'source') {
                sourceFields.classList.remove('hidden');
                costFields.classList.add('hidden');
            } else { // cost
                sourceFields.classList.add('hidden');
                costFields.classList.remove('hidden');
            }
        };
        
        const switchView = (viewId, projectId = null) => {
            if (['home-view', 'project-dashboard-view', 'history-view'].includes(viewId)) {
                currentProjectId = null;
            }
            if (projectId) currentProjectId = projectId;
            
            ['home-view', 'project-dashboard-view', 'sector-dashboard-view', 'sectors-view', 'history-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const viewToShow = document.getElementById(viewId);
            if(viewToShow) {
                viewToShow.classList.remove('hidden');
            } else {
                console.error(`A view com o ID "${viewId}" não foi encontrada.`);
                switchView('home-view'); // Fallback to home view
                return; 
            }

            const footer = document.getElementById('footer-nav');
            const homeNav = document.getElementById('home-nav');
            const sectorsNav = document.getElementById('sectors-nav');

            if (viewId === 'home-view') {
                footer.classList.remove('hidden');
                homeNav.classList.remove('hidden');
                sectorsNav.classList.add('hidden');
            } else if (viewId === 'sectors-view') {
                footer.classList.remove('hidden');
                homeNav.classList.add('hidden');
                sectorsNav.classList.remove('hidden');
            } else {
                footer.classList.add('hidden');
            }

            destroyActiveCharts();
            if (viewId === 'project-dashboard-view') renderProjectDashboardCharts(dashboardPeriodFilter);
            if (viewId === 'sector-dashboard-view') renderSectorDashboardCharts(dashboardPeriodFilter);
            if (viewId === 'history-view') {
                populateFilters();
                renderHistory();
            }
            if (viewId === 'sectors-view') {
                 const project = projects.find(p => p.id === currentProjectId);
                 if(project) {
                    document.getElementById('sectors-project-name').textContent = project.name;
                    renderSectorIndicators();
                 }
            }
        };

        const showResults = () => {
            if (currentProjectId) {
                switchView('sector-dashboard-view');
            } else {
                switchView('project-dashboard-view');
            }
        };

        const filterDashboardCharts = (period) => {
            dashboardPeriodFilter = period;
            document.querySelectorAll('.dashboard-filter-btn').forEach(btn => {
                const btnPeriod = btn.getAttribute('data-period');
                btn.classList.toggle('bg-indigo-600', btnPeriod === period);
                btn.classList.toggle('text-white', btnPeriod === period);
                btn.classList.toggle('bg-white', btnPeriod !== period);
                btn.classList.toggle('text-gray-700', btnPeriod !== period);
            });
            renderProjectDashboardCharts(period);
        };
        
        const filterSectorDashboardCharts = (period) => {
            dashboardPeriodFilter = period;
             document.querySelectorAll('.sector-dashboard-filter-btn').forEach(btn => {
                const btnPeriod = btn.getAttribute('data-period');
                btn.classList.toggle('bg-indigo-600', btnPeriod === period);
                btn.classList.toggle('text-white', btnPeriod === period);
                btn.classList.toggle('bg-white', btnPeriod !== period);
                btn.classList.toggle('text-gray-700', btnPeriod !== period);
            });
            renderSectorDashboardCharts(period);
        }

        const filterDashboardView = (mode) => {
            projectDashboardViewMode = mode;
            document.querySelectorAll('.dashboard-view-btn').forEach(btn => {
                const btnView = btn.getAttribute('data-view');
                btn.classList.toggle('bg-indigo-600', btnView === mode);
                btn.classList.toggle('text-white', btnView === mode);
                btn.classList.toggle('bg-white', btnView !== mode);
                btn.classList.toggle('text-gray-700', btnView !== mode);
            });
            renderProjectDashboardCharts(dashboardPeriodFilter);
        }

        const filterSectorView = (mode) => {
            sectorDashboardViewMode = mode;
            document.querySelectorAll('.sector-view-btn').forEach(btn => {
                const btnView = btn.getAttribute('data-view');
                btn.classList.toggle('bg-indigo-600', btnView === mode);
                btn.classList.toggle('text-white', btnView === mode);
                btn.classList.toggle('bg-white', btnView !== mode);
                btn.classList.toggle('text-gray-700', btnView !== mode);
            });
            renderSectorDashboardCharts(dashboardPeriodFilter);
        }
        
        const filterHistoryPeriod = (period) => {
            historyFilters.period = period;
            document.querySelectorAll('.history-filter-btn.period-btn').forEach(btn => {
                const btnPeriod = btn.getAttribute('data-period');
                btn.classList.toggle('bg-indigo-600', btnPeriod === period);
                btn.classList.toggle('text-white', btnPeriod === period);
                btn.classList.toggle('bg-white', btnPeriod !== period);
                btn.classList.toggle('text-gray-700', btnPeriod !== period);
            });
            renderHistory();
        };
        
        const populateFilters = () => {
            const sectorSelect = document.getElementById('sector-filter');
            sectorSelect.innerHTML = '<option value="all">Todos os Setores</option>';
            Object.keys(subsectorsBySector).filter(s => s !== 'all').forEach(sector => {
                sectorSelect.innerHTML += `<option value="${sector}">${sector}</option>`;
            });
            sectorSelect.value = historyFilters.sector;
            updateSubsectorFilter();
        };

        const updateSubsectorFilter = () => {
            const sector = document.getElementById('sector-filter').value;
            const subsectorSelect = document.getElementById('subsector-filter');
            subsectorSelect.innerHTML = '';
            const subsectors = subsectorsBySector[sector] || [];
            subsectors.forEach(sub => {
                const value = sub.toLowerCase().includes('todos') ? 'all' : sub;
                subsectorSelect.innerHTML += `<option value="${value}">${sub}</option>`;
            });
            subsectorSelect.value = historyFilters.subsector;
        };
        
        // --- INICIALIZAÇÃO E EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderTotalBalance();
            renderProjects();
            renderInvestmentSources();

            document.getElementById('investment-action-type').addEventListener('change', updateInvestmentFormUI);

            document.getElementById('project-form').addEventListener('submit', (e) => {
                e.preventDefault();
                projects.push({ id: `proj_${Date.now()}`, name: e.target.elements['project-name'].value, transactions: [] });
                saveData();
                renderProjects();
                renderSectorIndicators();
                closeModal('project-modal');
                e.target.reset();
            });
            
            // Listener para o formulário de Investimento
            document.getElementById('investment-form').addEventListener('submit', e => {
                e.preventDefault();
                const form = e.target;
                const actionType = form.elements['investment-action-type'].value;
                const project = projects.find(p => p.id === currentProjectId);
                if (!project) return;


                if (actionType === 'source') {
                    const name = form.elements['inv-source-name'].value;
                    const type = form.elements['inv-source-type'].value;
                    const balance = parseFloat(form.elements['inv-source-balance'].value);
                    if (!name || !type || isNaN(balance)) return;

                    const newSource = { id: `src_${Date.now()}`, name, type, balance };
                    sources.push(newSource);
                    
                    project.transactions.push({
                        type: 'revenue',
                        description: `Nova Fonte: ${name}`,
                        amount: balance,
                        sector: 'Financeiro',
                        subSector: 'Investimento',
                        sourceId: newSource.id,
                        date: new Date().toISOString().split('T')[0]
                    });

                } else { // 'cost'
                    const sourceId = form.elements['inv-cost-source'].value;
                    const source = sources.find(s => s.id === sourceId);
                    if (!sourceId || !source) return;

                    const amount = parseFloat(form.elements['inv-cost-amount'].value);
                    source.balance -= amount;

                    project.transactions.push({
                        type: 'cost',
                        description: form.elements['inv-cost-description'].value,
                        amount: amount,
                        sector: 'Financeiro',
                        subSector: 'Investimento',
                        sourceId: sourceId,
                        date: form.elements['inv-cost-date'].value
                    });
                }
                
                saveData();
                renderTotalBalance();
                renderProjects();
                renderInvestmentSources();
                renderSectorIndicators();
                closeModal('investment-modal');
            });

            // Listener para o formulário de Transações Padrão
            document.getElementById('transaction-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const sector = form.elements['transaction-sector'].value;
                const subSector = form.elements['transaction-subsector'].value;
                const type = form.elements['transaction-type'].value;
                const amount = parseFloat(form.elements['transaction-amount'].value);
                const description = form.elements['transaction-description'].value;
                const date = form.elements['transaction-date'].value;
                const project = projects.find(p => p.id === currentProjectId);
                if (!project) return console.error('Projeto inválido.');

                const sourceId = form.elements['transaction-source'].value;
                const sourceSelect = form.elements['transaction-source'];
                if (!sourceId) {
                    sourceSelect.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                    setTimeout(() => sourceSelect.classList.remove('border-red-500', 'ring-2', 'ring-red-500'), 2000);
                    return;
                }
                const source = sources.find(s => s.id === sourceId);
                if (!source) return console.error('Fonte de Recurso inválida.');

                source.balance += (type === 'revenue' ? amount : -amount);
                const newTransaction = { type, description, amount, sector, subSector, sourceId, date };
                project.transactions.push(newTransaction);
                
                saveData();
                renderTotalBalance();
                renderProjects();
                renderInvestmentSources();
                renderSectorIndicators();
                closeModal('transaction-modal');
            });

            document.getElementById('sector-filter').addEventListener('change', (e) => {
                historyFilters.sector = e.target.value;
                historyFilters.subsector = 'all'; 
                updateSubsectorFilter();
                renderHistory();
            });
            document.getElementById('subsector-filter').addEventListener('change', (e) => {
                historyFilters.subsector = e.target.value;
                renderHistory();
            });

            // Close modals on outside click
            ['project-modal', 'investment-modal', 'transaction-modal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modalId);
                    }
                });
            });
        });

        // History rendering
        const renderHistory = () => {
            const list = document.getElementById('history-list');
            if(!list) return; // Add guard clause
            list.innerHTML = '';
            
            let allTransactions = [];
            projects.forEach(p => {
                p.transactions.forEach(t => {
                    allTransactions.push({ ...t, projectName: p.name });
                });
            });

            let filteredTransactions = allTransactions.filter(t => isDateInPeriod(t.date, historyFilters.period));
            
            if (historyFilters.sector !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.sector === historyFilters.sector);
            }
            
            if (historyFilters.subsector !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.subSector === historyFilters.subsector);
            }

            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredTransactions.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center col-span-full">Nenhuma operação encontrada.</p>`;
                return;
            }

            filteredTransactions.forEach(t => {
                const item = document.createElement('div');
                const isRevenue = t.type === 'revenue';
                item.className = `history-item ${isRevenue ? 'history-item-revenue' : 'history-item-cost'}`;
                
                item.innerHTML = `
                    <div class="flex-grow pr-4">
                        <p class="font-bold text-gray-800">${t.description}</p>
                        <p class="text-sm text-gray-500">${t.projectName} - ${new Date(t.date).toLocaleDateString('pt-BR')}</p>
                        <p class="text-xs text-gray-400">${t.sector} / ${t.subSector}</p>
                    </div>
                    <p class="font-bold text-lg whitespace-nowrap ${isRevenue ? 'text-green-600' : 'text-red-600'}">${isRevenue ? '+' : '-'} ${formatCurrency(t.amount)}</p>
                `;
                list.appendChild(item);
            });
        };
    </script>
</body>
</html>

