<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Caixa (Firebase com Login)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Estilos CSS -->
    <style>
        /* Estilos básicos e do tema escuro */
        :root {
            --bg-color: #f3f4f6; /* gray-100 */
            --text-color: #1f2937; /* gray-800 */
            --card-bg-color: #ffffff;
            --header-bg-color: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }
        html.dark {
            --bg-color: #111827; /* gray-900 */
            --text-color: #f9fafb; /* gray-50 */
            --card-bg-color: #1f2937; /* gray-800 */
            --header-bg-color: #1f2937;
            --border-color: #374151; /* gray-700 */
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .card, header, footer {
            background-color: var(--card-bg-color);
            border-color: var(--border-color);
        }
        header { background-color: var(--header-bg-color); }
        .project-card, .sector-card, .source-item, .trash-item, .history-item, .chart-card {
            background-color: var(--card-bg-color);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        main { overflow-y: auto; height: 100%; position: relative; }
        .subsector-button { transition: background-color 0.2s, transform 0.2s; }
        .subsector-button:active { transform: scale(0.98); background-color: #f0f0f0; }
        html.dark .subsector-button:active { background-color: #374151; }
        .source-item, .trash-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .history-item, .project-card, .sector-card { display: flex; flex-direction: column; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .history-item { border-left-width: 5px; }
        .project-card, .sector-card { border-top-width: 5px; }
        .history-item-revenue, .card-positive { border-color: #22c55e; }
        .history-item-cost, .card-negative { border-color: #ef4444; }
        .card-neutral { border-color: #f59e0b; }
        .chart-card { height: 280px; display: flex; flex-direction: column; }
        .chart-card h2, .chart-card h3 { text-align: center; font-weight: bold; margin-bottom: 0.5rem; flex-shrink: 0; font-size: 1rem; }
        .chart-card canvas { flex-grow: 1; min-height: 0; }
        .sector-card-financeiro { border-color: #ef4444; }
        .sector-card-operacional { border-color: #f59e0b; }
        .sector-card-comercial { border-color: #22c55e; }
        #notification-banner { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="transition-colors duration-300">

    <!-- Container de Autenticação -->
    <div id="auth-container" class="w-full h-full">
        <!-- Tela 1: Landing Page -->
        <div id="landing-view" class="w-full h-full flex flex-col justify-center items-center p-6 text-center bg-gray-50 dark:bg-gray-900">
            <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-600 mb-4">Meu Caixa</h1>
            <p class="text-lg md:text-xl text-gray-600 dark:text-gray-300 max-w-2xl mb-8">O controle financeiro dos seus projetos, simplificado. Acompanhe receitas, custos e resultados em tempo real, do seu celular ou desktop.</p>
            <div class="space-y-4 w-full max-w-xs">
                <button onclick="switchAuthView('signup-view')" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">
                    Criar Minha Conta Grátis
                </button>
                <button onclick="switchAuthView('login-view')" class="w-full text-indigo-600 dark:text-indigo-400 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-50 dark:hover:bg-gray-800">
                    Já tenho uma conta
                </button>
                <button onclick="handleAnonymousLogin()" class="w-full text-sm text-gray-500 dark:text-gray-400 font-semibold py-2 px-4 rounded-lg hover:underline">
                    Continuar para demonstração
                </button>
            </div>
        </div>

        <!-- Tela 2: Formulário de Criação de Conta -->
        <div id="signup-view" class="hidden w-full h-full flex flex-col justify-center items-center p-6 bg-gray-50 dark:bg-gray-900">
            <div class="w-full max-w-sm card p-8 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2>
                <form id="signup-form" class="space-y-4">
                    <input id="signup-email" type="email" placeholder="Seu melhor e-mail" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                    <input id="signup-password" type="password" placeholder="Crie uma senha forte" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Cadastrar</button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-6">
                    Já tem uma conta? <button onclick="switchAuthView('login-view')" class="font-semibold text-indigo-600 hover:underline">Faça login</button>
                </p>
            </div>
        </div>

        <!-- Tela 3: Login -->
        <div id="login-view" class="hidden w-full h-full flex flex-col justify-center items-center p-6 bg-gray-50 dark:bg-gray-900">
            <div class="w-full max-w-sm card p-8 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-center mb-6">Fazer Login</h2>
                <form id="login-form" class="space-y-4">
                    <input id="login-email" type="email" placeholder="E-mail" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                    <input id="login-password" type="password" placeholder="Senha" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Entrar</button>
                </form>
                <div class="text-center text-sm mt-6 flex justify-between">
                    <button onclick="switchAuthView('forgot-password-view')" class="font-semibold text-indigo-600 hover:underline">Esqueci a senha</button>
                    <button onclick="switchAuthView('signup-view')" class="font-semibold text-indigo-600 hover:underline">Criar conta</button>
                </div>
            </div>
        </div>
        
        <!-- Tela 4: Esqueci Minha Senha -->
        <div id="forgot-password-view" class="hidden w-full h-full flex flex-col justify-center items-center p-6 bg-gray-50 dark:bg-gray-900">
             <div class="w-full max-w-sm card p-8 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-center mb-2">Redefinir Senha</h2>
                <p class="text-center text-gray-500 mb-6">Enviaremos um link de redefinição para o seu e-mail.</p>
                <form id="forgot-password-form" class="space-y-4">
                    <input id="forgot-email" type="email" placeholder="Digite seu e-mail de cadastro" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Enviar Link</button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-6">
                    Lembrou a senha? <button onclick="switchAuthView('login-view')" class="font-semibold text-indigo-600 hover:underline">Faça login</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Tela de Carregamento (usada após o login) -->
    <div id="loading-view" class="hidden fixed inset-0 bg-white dark:bg-gray-900 flex flex-col items-center justify-center z-[200]">
        <h1 class="text-3xl font-bold text-indigo-600 mb-4">Meu Caixa</h1>
        <p id="loading-text" class="text-gray-600 dark:text-gray-300">Carregando seus dados...</p>
        <svg class="animate-spin h-8 w-8 text-indigo-600 mt-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Container principal do aplicativo -->
    <div id="app-container" class="hidden h-full">
        <div id="notification-banner" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[100] transition-transform duration-300 transform -translate-y-20">
            <p id="notification-text"></p>
        </div>

        <header class="fixed top-0 left-0 right-0 p-4 shadow-md z-10 flex justify-between items-center">
            <div>
                <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Saldo Total Consolidado</h2>
                <p id="total-balance" class="text-3xl font-bold">R$ 0,00</p>
            </div>
            <div class="relative">
                <button id="profile-button" class="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </button>
                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-64 card rounded-xl shadow-lg p-2 z-20">
                    <div class="px-2 py-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Logado como</p>
                        <p id="user-email-display" class="font-semibold truncate"></p>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                    <a href="#" class="block px-4 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Trocar Senha</a>
                    <a href="#" class="block px-4 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Alterar E-mail</a>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                    <div class="px-4 py-2 flex justify-between items-center">
                        <span class="text-sm">Modo Escuro</span>
                        <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-indigo-600">
                            <span id="theme-toggle-dot" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                        </button>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                     <div class="px-4 py-2">
                        <p class="text-sm">Status do Plano: <span class="font-bold text-green-500">Free</span></p>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                    <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-500 dark:hover:text-white">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <main class="pt-24 pb-20 md:pt-28">
            <div id="home-view">
                <div class="p-6 max-w-7xl mx-auto">
                    <h1 class="text-2xl font-bold mb-4">Meus Projetos</h1>
                    <div id="project-carousel" class="flex overflow-x-auto gap-4 snap-x pb-4 md:grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 md:overflow-visible"></div>
                </div>
                <div id="investment-sources-list-container" class="p-6 max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Fontes de Investimento</h2>
                    <div id="investment-sources-list" class="space-y-3"></div>
                </div>
            </div>
            <div id="sectors-view" class="hidden p-6 max-w-7xl mx-auto">
                <div class="flex items-center mb-4 relative">
                     <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                     </button>
                     <h1 id="sectors-project-name" class="text-2xl font-bold w-full text-center"></h1>
                </div>
                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Selecione uma ação ou subsetor.</p>
                <div class="flex overflow-x-auto gap-4 snap-x pb-4 md:grid md:grid-cols-3 md:overflow-visible">
                    <div class="sector-card sector-card-financeiro flex-shrink-0 w-full max-w-[16rem] mx-auto flex flex-col p-4 snap-center">
                        <h3 class="text-xl font-bold">Financeiro</h3>
                        <div id="financeiro-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2"></div>
                        <div class="flex-grow space-y-2 flex flex-col justify-center">
                           <button onclick="openInvestmentModal()" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Investimento</button>
                           <button onclick="openTransactionModal('Financeiro', 'Planejamento')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Planejamento</button>
                           <button onclick="openTransactionModal('Financeiro', 'Recursos')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Recursos</button>
                        </div>
                    </div>
                    <div class="sector-card sector-card-operacional flex-shrink-0 w-full max-w-[16rem] mx-auto flex flex-col p-4 snap-center">
                         <h3 class="text-xl font-bold">Operacional</h3>
                        <div id="operacional-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2"></div>
                        <div class="flex-grow space-y-2 flex flex-col justify-center">
                           <button onclick="openTransactionModal('Operacional', 'Treinamento')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Treinamento</button>
                           <button onclick="openTransactionModal('Operacional', 'Armazenamento')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Armazenamento</button>
                           <button onclick="openTransactionModal('Operacional', 'Produção')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Produção</button>
                        </div>
                    </div>
                    <div class="sector-card sector-card-comercial flex-shrink-0 w-full max-w-[16rem] mx-auto flex flex-col p-4 snap-center">
                        <h3 class="text-xl font-bold">Comercial</h3>
                         <div id="comercial-indicators" class="text-sm space-y-1 my-4 border-t border-b py-2"></div>
                         <div class="flex-grow space-y-2 flex flex-col justify-center">
                           <button onclick="openTransactionModal('Comercial', 'Marketing')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Marketing</button>
                           <button onclick="openTransactionModal('Comercial', 'Relacionamento')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Relacionamento</button>
                           <button onclick="openTransactionModal('Comercial', 'Vendas')" class="subsector-button w-full text-left p-3 rounded-lg border dark:border-gray-600">Vendas</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="project-dashboard-view" class="hidden p-6 max-w-7xl mx-auto">
                 <div class="flex items-center mb-4 relative">
                     <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                     <h1 class="text-2xl font-bold w-full text-center">Resultados dos Projetos</h1>
                 </div>
                 <div class="flex justify-center gap-2 mb-2">
                     <button onclick="filterDashboardCharts('week')" data-period="week" class="dashboard-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Semana</button>
                     <button onclick="filterDashboardCharts('month')" data-period="month" class="dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Mês</button>
                     <button onclick="filterDashboardCharts('year')" data-period="year" class="dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Ano</button>
                 </div>
                 <div class="flex justify-center gap-2 mb-4 border-t pt-4 mt-4">
                     <button onclick="filterDashboardView('bars')" data-view="bars" class="dashboard-view-btn view-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Barras</button>
                     <button onclick="filterDashboardView('pizza')" data-view="pizza" class="dashboard-view-btn view-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Pizza</button>
                 </div>
                 <div id="project-charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            <div id="sector-dashboard-view" class="hidden p-6 max-w-7xl mx-auto">
                 <div class="flex items-center mb-4 relative">
                     <button onclick="switchView('sectors-view', currentProjectId)" class="absolute left-0 p-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                     <h1 class="text-2xl font-bold w-full text-center">Resultados dos Setores</h1>
                 </div>
                  <div class="flex justify-center gap-2 mb-2">
                     <button onclick="filterSectorDashboardCharts('week')" data-period="week" class="sector-dashboard-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Semana</button>
                     <button onclick="filterSectorDashboardCharts('month')" data-period="month" class="sector-dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Mês</button>
                     <button onclick="filterSectorDashboardCharts('year')" data-period="year" class="sector-dashboard-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Ano</button>
                 </div>
                  <div class="flex justify-center gap-2 mb-4 border-t pt-4 mt-4">
                     <button onclick="filterSectorView('bars')" data-view="bars" class="sector-view-btn view-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Barras</button>
                     <button onclick="filterSectorView('pizza')" data-view="pizza" class="sector-view-btn view-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold">Pizza</button>
                 </div>
                 <div id="sector-charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            <div id="history-view" class="hidden p-6 max-w-7xl mx-auto">
                <div class="flex items-center mb-4 relative">
                    <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-2xl font-bold w-full text-center">Histórico</h1>
                </div>
                <div id="history-filters" class="mb-4 space-y-3 card p-3 rounded-xl shadow">
                    <div class="flex justify-center gap-2">
                         <button onclick="filterHistoryPeriod('week')" data-period="week" class="history-filter-btn period-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold flex-1">Semana</button>
                         <button onclick="filterHistoryPeriod('month')" data-period="month" class="history-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold flex-1">Mês</button>
                         <button onclick="filterHistoryPeriod('year')" data-period="year" class="history-filter-btn period-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold flex-1">Ano</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="sector-filter" class="w-full p-2 border rounded-lg text-sm bg-gray-50 dark:bg-gray-700"></select>
                        <select id="subsector-filter" class="w-full p-2 border rounded-lg text-sm bg-gray-50 dark:bg-gray-700"></select>
                    </div>
                </div>
                <div id="history-list" class="space-y-3"></div>
           </div>
           <div id="trash-view" class="hidden p-6 max-w-7xl mx-auto">
                <div class="flex items-center mb-4 relative">
                    <button onclick="switchView('home-view')" class="absolute left-0 p-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-2xl font-bold w-full text-center">Lixeira</h1>
                     <button onclick="confirmClearTrash()" class="absolute right-0 p-2 text-red-500 hover:text-red-700" title="Esvaziar Lixeira"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
                <div id="deleted-projects-container" class="mb-8">
                    <h2 class="text-xl font-bold mb-4">Projetos Excluídos</h2>
                    <div id="deleted-projects-list" class="space-y-3"></div>
                </div>
                <div id="deleted-sources-container">
                    <h2 class="text-xl font-bold mb-4">Fontes de Investimento Excluídas</h2>
                    <div id="deleted-sources-list" class="space-y-3"></div>
                </div>
           </div>
        </main>

        <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 shadow-t-lg border-t p-2 flex justify-around items-center z-10">
            <div id="home-nav" class="w-full flex justify-around items-center">
                 <button onclick="switchView('history-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><span class="text-xs">Histórico</span></button>
                 <button onclick="openModal('project-modal')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-xs">Criar Projeto</span></button>
                 <button onclick="showResults()" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs">Resultados</span></button>
                  <button onclick="switchView('trash-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span class="text-xs">Lixeira</span></button>
            </div>
            <div id="sectors-nav" class="w-full flex justify-around items-center hidden">
                  <button onclick="switchView('history-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><span class="text-xs">Histórico</span></button>
                 <button onclick="switchView('home-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 002 2h10a2 2 0 002-2V10M9 20v-6a2 2 0 012-2h2a2 2 0 012 2v6" /></svg><span class="text-xs">Home</span></button>
                 <button onclick="showResults()" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs">Resultados</span></button>
                  <button onclick="switchView('trash-view')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span class="text-xs">Lixeira</span></button>
            </div>
        </footer>

        <!-- Modals -->
        <div id="project-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl">
                <h2 class="text-xl font-bold mb-4">Novo Projeto</h2>
                <form id="project-form">
                    <div class="mb-4">
                        <label for="project-name" class="block text-sm font-medium mb-1">Nome do Projeto</label>
                        <input type="text" id="project-name" placeholder="Ex: Lançamento App Mobile" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required>
                    </div>
                     <div class="flex justify-end gap-2">
                         <button type="button" onclick="closeModal('project-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
                         <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Registrar</button>
                     </div>
                </form>
            </div>
        </div>
        <div id="investment-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl">
                <h2 class="text-xl font-bold mb-2">Ação de Investimento</h2>
                <h3 id="investment-project-name" class="text-indigo-600 font-semibold mb-4"></h3>
                <form id="investment-form">
                    <div class="mb-4">
                        <label for="investment-action-type" class="block text-sm font-medium mb-1">Tipo de Ação</label>
                        <select id="investment-action-type" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700"><option value="source">Fonte de Investimento</option><option value="cost">Custo</option></select>
                    </div>
                    <div id="investment-source-fields">
                        <div class="mb-4">
                            <label for="inv-source-name" class="block text-sm font-medium mb-1">Nome da Fonte</label>
                            <input type="text" id="inv-source-name" placeholder="Ex: Investidor Anjo" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        </div>
                        <div class="mb-4">
                            <label for="inv-source-type" class="block text-sm font-medium mb-1">Tipo</label>
                            <select id="inv-source-type" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700"><option>Meu Caixa</option><option>Investidor Anjo</option><option>Empréstimo</option><option>Crédito</option><option>Corretora</option></select>
                        </div>
                        <div class="mb-4">
                            <label for="inv-source-balance" class="block text-sm font-medium mb-1">Saldo Inicial</label>
                            <input type="number" id="inv-source-balance" placeholder="1000.00" step="0.01" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        </div>
                    </div>
                    <div id="investment-cost-fields" class="hidden">
                         <div class="mb-4">
                             <label for="inv-cost-description" class="block text-sm font-medium mb-1">Nome da Operação</label>
                             <input type="text" id="inv-cost-description" placeholder="Ex: Taxa de Abertura" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        </div>
                        <div class="mb-4">
                             <label for="inv-cost-date" class="block text-sm font-medium mb-1">Data</label>
                             <input type="date" id="inv-cost-date" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        </div>
                         <div class="mb-4">
                             <label for="inv-cost-source" class="block text-sm font-medium mb-1">Debitar da Fonte</label>
                             <select id="inv-cost-source" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700"></select>
                        </div>
                        <div class="mb-4">
                             <label for="inv-cost-amount" class="block text-sm font-medium mb-1">Valor do Custo</label>
                             <input type="number" id="inv-cost-amount" placeholder="100.00" step="0.01" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700">
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModal('investment-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="transaction-modal" onclick="closeModalOnOutsideClick(event)" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl">
                <h2 class="text-xl font-bold mb-2">Adicionar Operação</h2>
                <h3 id="transaction-project-name" class="text-indigo-600 font-semibold mb-4"></h3>
                <form id="transaction-form">
                    <input type="hidden" id="transaction-sector"><input type="hidden" id="transaction-subsector">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium mb-1">Tipo</label>
                            <select id="transaction-type" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required><option value="cost">Custo</option><option value="revenue">Receita</option></select>
                        </div>
                         <div>
                             <label for="transaction-date" class="block text-sm font-medium mb-1">Data</label>
                             <input type="date" id="transaction-date" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required>
                        </div>
                    </div>
                     <div class="mb-4">
                         <label for="transaction-description" class="block text-sm font-medium mb-1">Nome da Operação</label>
                         <input type="text" id="transaction-description" placeholder="Ex: Venda de licença" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required>
                    </div>
                     <div id="transaction-source-wrapper" class="mb-4">
                         <label for="transaction-source" class="block text-sm font-medium mb-1">Fonte de Investimento</label>
                         <select id="transaction-source" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required></select>
                     </div>
                    <div class="mb-4">
                         <label for="transaction-amount" class="block text-sm font-medium mb-1">Valor</label>
                         <input type="number" id="transaction-amount" placeholder="500.00" step="0.01" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" required>
                    </div>
                    <div class="flex justify-end gap-2">
                         <button type="button" onclick="closeModal('transaction-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancelar</button>
                         <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut, sendPasswordResetEmail,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, collection, 
            addDoc, updateDoc, deleteDoc, writeBatch, arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- REFERÊNCIAS GLOBAIS ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let unsubscribeProjects = () => {};
        let unsubscribeSources = () => {};

        // --- LÓGICA DE TEMA (CLARO/ESCURO) ---
        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
        };
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- LÓGICA DE AUTENTICAÇÃO E UI ---
        const authContainer = document.getElementById('auth-container');
        const loadingView = document.getElementById('loading-view');
        const appContainer = document.getElementById('app-container');
        
        const switchAuthView = (viewId) => {
            ['landing-view', 'signup-view', 'login-view', 'forgot-password-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        };

        onAuthStateChanged(auth, user => {
            if (user) { // Se houver qualquer usuário (autenticado ou anônimo)
                userId = user.uid;
                authContainer.classList.add('hidden');
                loadingView.classList.remove('hidden');
                
                if (user.isAnonymous) {
                    document.getElementById('user-email-display').textContent = 'Modo Demonstração';
                } else {
                    document.getElementById('user-email-display').textContent = user.email;
                }

                startFirestoreListeners();
            } else { // Se não há usuário
                userId = null;
                unsubscribeProjects();
                unsubscribeSources();
                appContainer.classList.add('hidden');
                loadingView.classList.add('hidden');
                authContainer.classList.remove('hidden');
                switchAuthView('landing-view');
            }
        });
        
        const handleSignup = (email, password) => {
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => alert(`Erro no cadastro: ${error.message}`));
        };
        const handleLogin = (email, password) => {
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => alert(`Erro no login: ${error.message}`));
        };
        const handlePasswordReset = (email) => {
            sendPasswordResetEmail(auth, email)
                .then(() => alert('Link de redefinição enviado para o seu e-mail.'))
                .catch(error => alert(`Erro ao enviar e-mail: ${error.message}`));
        };
        const handleLogout = () => {
            signOut(auth).catch(error => console.error('Erro no logout:', error));
        };
        
        const handleAnonymousLogin = () => {
            signInAnonymously(auth)
                .catch(error => {
                    console.error("Erro no login anônimo:", error);
                    alert("Não foi possível entrar no modo demonstração. Tente novamente.");
                });
        };
        
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleSignup(e.target.elements['signup-email'].value, e.target.elements['signup-password'].value);
        });
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin(e.target.elements['login-email'].value, e.target.elements['login-password'].value);
        });
        document.getElementById('forgot-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handlePasswordReset(e.target.elements['forgot-email'].value);
        });

        // --- LÓGICA DO FIRESTORE E DO APLICATIVO PRINCIPAL ---
        
        let sources = [];
        let projects = [];
        let activeCharts = [];
        let currentProjectId = null;
        let historyFilters = { period: 'week', sector: 'all', subsector: 'all' };
        let dashboardPeriodFilter = 'week';
        let projectDashboardViewMode = 'bars';
        let sectorDashboardViewMode = 'bars';
        const subsectorsBySector = { 'all': ['Todos os Subsetores'], 'Financeiro': ['Todos', 'Investimento', 'Planejamento', 'Recursos'], 'Operacional': ['Todos', 'Treinamento', 'Armazenamento', 'Produção'], 'Comercial': ['Todos', 'Marketing', 'Relacionamento', 'Vendas'] };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        function startFirestoreListeners() {
            unsubscribeProjects();
            unsubscribeSources();
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const projectsCollectionPath = `/artifacts/${appId}/users/${userId}/projects`;
            const sourcesCollectionPath = `/artifacts/${appId}/users/${userId}/sources`;

            const projectsCollection = collection(db, projectsCollectionPath);
            unsubscribeProjects = onSnapshot(projectsCollection, (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
                loadingView.classList.add('hidden');
                appContainer.classList.remove('hidden');
            });

            const sourcesCollection = collection(db, sourcesCollectionPath);
            unsubscribeSources = onSnapshot(sourcesCollection, (snapshot) => {
                sources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        const renderTotalBalance = () => { document.getElementById('total-balance').textContent = formatCurrency(sources.filter(s => !s.deleted).reduce((sum, source) => sum + parseFloat(source.balance), 0)); };
        
        const renderProjects = () => {
            const carousel = document.getElementById('project-carousel');
            carousel.innerHTML = '';
            const activeProjects = projects.filter(p => !p.deleted);

            if (activeProjects.length === 0) {
                carousel.innerHTML = `<div class="project-card flex-shrink-0 w-full max-w-xs mx-auto p-6 snap-center"><div class="flex flex-col items-center justify-center text-center h-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="font-bold text-lg">Nenhum projeto ainda</h3><p class="text-gray-500 dark:text-gray-400">Clique em "Criar Projeto" para começar.</p></div></div>`;
                return;
            }

            activeProjects.forEach(project => {
                const totalRevenue = (project.transactions || []).filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = (project.transactions || []).filter(t => t.type === 'cost').reduce((sum, t) => sum + t.amount, 0);
                const projectBalance = totalRevenue - totalCost;

                const card = document.createElement('div');
                let borderColorClass = 'card-neutral';
                if (projectBalance > 0) borderColorClass = 'card-positive';
                else if (projectBalance < 0) borderColorClass = 'card-negative';
                
                card.className = `project-card ${borderColorClass} flex-shrink-0 w-full max-w-xs mx-auto snap-center cursor-pointer hover:shadow-xl transition relative`;
                card.setAttribute('onclick', `switchView('sectors-view', '${project.id}')`);
                card.innerHTML = `
                    <button onclick="moveItemToTrash(event, 'project', '${project.id}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    <h3 class="font-bold text-xl mb-2">${project.name}</h3>
                    <div class="space-y-2 text-sm border-t pt-2 mt-2 dark:border-gray-700">
                        <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">Receita</span><span class="font-semibold text-green-500">${formatCurrency(totalRevenue)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">Custo</span><span class="font-semibold text-red-500">${formatCurrency(totalCost)}</span></div>
                        <div class="flex justify-between border-t pt-2 mt-2 dark:border-gray-700"><span class="font-bold">Resultado</span><span class="font-bold ${projectBalance >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(projectBalance)}</span></div>
                    </div>`;
                carousel.appendChild(card);
            });
        };
        const renderInvestmentSources = () => {
            const list = document.getElementById('investment-sources-list');
            list.innerHTML = '';
            const activeSources = sources.filter(s => !s.deleted);

            if (activeSources.length === 0) {
                list.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">Nenhuma fonte de investimento cadastrada.</p>`;
                return;
            }
            activeSources.forEach(source => {
                const item = document.createElement('div');
                item.className = 'source-item';
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold">${source.name}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${source.type}</p>
                    </div>
                    <p class="font-bold text-lg ${source.balance >= 0 ? 'text-green-600' : 'text-red-600'} mr-4">${formatCurrency(source.balance)}</p>
                    <button onclick="moveItemToTrash(null, 'source', '${source.id}')" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                list.appendChild(item);
            });
        };
        const renderSectorIndicators = () => {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            ['Financeiro', 'Operacional', 'Comercial'].forEach(sector => {
                const transactions = project.transactions || [];
                const sectorTransactions = transactions.filter(t => t.sector === sector);
                const totalRevenue = sectorTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = sectorTransactions.filter(t => t.type === 'cost').reduce((sum, t) => sum + t.amount, 0);
                const result = totalRevenue - totalCost;
                
                const indicatorDiv = document.getElementById(`${sector.toLowerCase()}-indicators`);
                if (indicatorDiv) {
                    indicatorDiv.innerHTML = `
                        <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">Receita</span><span class="font-semibold text-green-500">${formatCurrency(totalRevenue)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">Custo</span><span class="font-semibold text-red-500">${formatCurrency(totalCost)}</span></div>
                         <div class="flex justify-between border-t mt-2 pt-2 dark:border-gray-700"><span class="font-bold">Resultado</span><span class="font-bold ${result >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(result)}</span></div>`;
                }
            });
        };
       
        const destroyActiveCharts = () => { activeCharts.forEach(chart => chart.destroy()); activeCharts = []; };

        function createChart(container, title, chartConfig) { const card = document.createElement('div'); card.className = 'chart-card'; card.innerHTML = `<h2>${title}</h2><canvas></canvas>`; container.appendChild(card); const canvas = card.querySelector('canvas'); if (canvas) { activeCharts.push(new Chart(canvas.getContext('2d'), chartConfig)); } }
        
        function renderProjectDashboardCharts(period = 'week') { destroyActiveCharts(); const container = document.getElementById('project-charts-container'); container.innerHTML = ''; const activeProjects = projects.filter(p => !p.deleted); if (projectDashboardViewMode === 'pizza') { const pieData = activeProjects.reduce((acc, project) => { const revenue = (project.transactions || []).filter(t => t.type === 'revenue' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0); const cost = (project.transactions || []).filter(t => t.type === 'cost' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0); if (revenue > 0) { acc.revenues.data.push(revenue); acc.revenues.labels.push(project.name); } if (cost > 0) { acc.costs.data.push(cost); acc.costs.labels.push(project.name); } return acc; }, { revenues: { labels: [], data: [] }, costs: { labels: [], data: [] } }); if (pieData.revenues.data.length > 0) createChart(container, 'Receita por Projeto', { type: 'pie', data: { labels: pieData.revenues.labels, datasets: [{ data: pieData.revenues.data, backgroundColor: ['#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107'] }] }, options: { responsive: true, maintainAspectRatio: false } }); if (pieData.costs.data.length > 0) createChart(container, 'Custo por Projeto', { type: 'pie', data: { labels: pieData.costs.labels, datasets: [{ data: pieData.costs.data, backgroundColor: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5'] }] }, options: { responsive: true, maintainAspectRatio: false } }); } else { activeProjects.forEach(project => { const data = aggregateDataForPeriod(project.transactions || [], period); createChart(container, `Desempenho: ${project.name}`, { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Receita', data: data.revenues, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Custo', data: data.costs, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false } }); }); } }
        
        function renderSectorDashboardCharts(period = 'week') { destroyActiveCharts(); const container = document.getElementById('sector-charts-container'); container.innerHTML = ''; const project = projects.find(p => p.id === currentProjectId); if (!project) return; const allSubsectors = ['Investimento', 'Planejamento', 'Recursos', 'Treinamento', 'Armazenamento', 'Produção', 'Marketing', 'Relacionamento', 'Vendas']; if (sectorDashboardViewMode === 'pizza') { const pieData = allSubsectors.reduce((acc, subsector) => { const revenue = (project.transactions || []).filter(t => t.subSector === subsector && t.type === 'revenue' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0); const cost = (project.transactions || []).filter(t => t.subSector === subsector && t.type === 'cost' && isDateInPeriod(t.date, period)).reduce((sum, t) => sum + t.amount, 0); if (revenue > 0) { acc.revenues.data.push(revenue); acc.revenues.labels.push(subsector); } if (cost > 0) { acc.costs.data.push(cost); acc.costs.labels.push(subsector); } return acc; }, { revenues: { labels: [], data: [] }, costs: { labels: [], data: [] } }); if (pieData.revenues.data.length > 0) createChart(container, 'Receita por Subsetor', { type: 'pie', data: { labels: pieData.revenues.labels, datasets: [{ data: pieData.revenues.data, backgroundColor: ['#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#795548', '#607D8B', '#009688'] }] }, options: { responsive: true, maintainAspectRatio: false } }); if (pieData.costs.data.length > 0) createChart(container, 'Custo por Subsetor', { type: 'pie', data: { labels: pieData.costs.labels, datasets: [{ data: pieData.costs.data, backgroundColor: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#f43f5e'] }] }, options: { responsive: true, maintainAspectRatio: false } }); } else { allSubsectors.forEach(subsector => { const transactions = (project.transactions || []).filter(t => t.subSector === subsector && isDateInPeriod(t.date, period)); const data = aggregateDataForPeriod(transactions, period); createChart(container, `Desempenho: ${subsector}`, { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Receita', data: data.revenues, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Custo', data: data.costs, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false } }); }); } }
        
        function isDateInPeriod(dateString, period) { const date = new Date(dateString); const now = new Date(); let startDate = new Date(); if (period === 'week') { startDate.setDate(now.getDate() - now.getDay()); startDate.setHours(0, 0, 0, 0); } else if (period === 'month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); } else { startDate = new Date(now.getFullYear(), 0, 1); } return date >= startDate; }
        
        function aggregateDataForPeriod(transactions, period) { const result = { labels: [], revenues: [], costs: [] }; const filtered = transactions.filter(t => isDateInPeriod(t.date, period)); if (period === 'week') { result.labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']; result.revenues = Array(7).fill(0); result.costs = Array(7).fill(0); filtered.forEach(t => { const day = new Date(t.date).getUTCDay(); if (t.type === 'revenue') result.revenues[day] += t.amount; else result.costs[day] += t.amount; }); } else if (period === 'month') { const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate(); result.labels = Array.from({ length: daysInMonth }, (_, i) => i + 1); result.revenues = Array(daysInMonth).fill(0); result.costs = Array(daysInMonth).fill(0); filtered.forEach(t => { const day = new Date(t.date).getUTCDate() - 1; if (t.type === 'revenue') result.revenues[day] += t.amount; else result.costs[day] += t.amount; }); } else { result.labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']; result.revenues = Array(12).fill(0); result.costs = Array(12).fill(0); filtered.forEach(t => { const month = new Date(t.date).getUTCMonth(); if (t.type === 'revenue') result.revenues[month] += t.amount; else result.costs[month] += t.amount; }); } return result; }
        
        const openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden'); 
        const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden'); 
        
        function closeModalOnOutsideClick(event) { if (event.target.id.endsWith('-modal')) { closeModal(event.target.id); } }
        
        const openTransactionModal = (sector, subSector) => { const project = projects.find(p => p.id === currentProjectId); if (!project) return; const form = document.getElementById('transaction-form'); form.reset(); document.getElementById('transaction-project-name').textContent = `${project.name} / ${sector} / ${subSector}`; form.elements['transaction-sector'].value = sector; form.elements['transaction-subsector'].value = subSector; form.elements['transaction-date'].valueAsDate = new Date(); const sourceSelect = document.getElementById('transaction-source'); sourceSelect.innerHTML = ''; if (sources.filter(s => !s.deleted).length === 0) { sourceSelect.innerHTML = '<option value="" disabled selected>Nenhuma fonte criada</option>'; } else { sources.filter(s => !s.deleted).forEach(source => { const option = document.createElement('option'); option.value = source.id; option.textContent = `${source.name} (${source.type})`; sourceSelect.appendChild(option); }); } openModal('transaction-modal'); };
        
        const openInvestmentModal = () => { const project = projects.find(p => p.id === currentProjectId); if (!project) { return alert("Por favor, selecione um projeto na tela inicial antes de realizar uma ação de investimento."); } document.getElementById('investment-form').reset(); document.getElementById('investment-project-name').textContent = `${project.name} / Financeiro / Investimento`; const sourceSelect = document.getElementById('inv-cost-source'); sourceSelect.innerHTML = ''; if (sources.filter(s => !s.deleted).length === 0) { sourceSelect.innerHTML = '<option value="" disabled selected>Nenhuma fonte criada</option>'; } else { sources.filter(s => !s.deleted).forEach(source => { const option = document.createElement('option'); option.value = source.id; option.textContent = `${source.name} (${source.type})`; sourceSelect.appendChild(option); }); } document.getElementById('inv-cost-date').valueAsDate = new Date(); updateInvestmentFormUI(); openModal('investment-modal'); };
        
        const updateInvestmentFormUI = () => { const actionType = document.getElementById('investment-action-type').value; const sourceFields = document.getElementById('investment-source-fields'); const costFields = document.getElementById('investment-cost-fields'); if (actionType === 'source') { sourceFields.classList.remove('hidden'); costFields.classList.add('hidden'); } else { sourceFields.classList.add('hidden'); costFields.classList.remove('hidden'); } };
        
        const switchView = (viewId, projectId = null) => { if (['home-view', 'project-dashboard-view', 'history-view', 'trash-view'].includes(viewId)) { currentProjectId = null; } if (projectId) currentProjectId = projectId; ['home-view', 'project-dashboard-view', 'sector-dashboard-view', 'sectors-view', 'history-view', 'trash-view'].forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); }); const viewToShow = document.getElementById(viewId); if (!viewToShow) { console.error(`A view com o ID "${viewId}" não foi encontrada.`); return switchView('home-view'); } viewToShow.classList.remove('hidden'); const footer = document.getElementById('footer-nav'); const homeNav = document.getElementById('home-nav'); const sectorsNav = document.getElementById('sectors-nav'); if (viewId === 'home-view') { footer.classList.remove('hidden'); homeNav.classList.remove('hidden'); sectorsNav.classList.add('hidden'); } else if (viewId === 'sectors-view') { footer.classList.remove('hidden'); homeNav.classList.add('hidden'); sectorsNav.classList.remove('hidden'); } else { footer.classList.add('hidden'); } destroyActiveCharts(); if (viewId === 'project-dashboard-view') renderProjectDashboardCharts(dashboardPeriodFilter); if (viewId === 'sector-dashboard-view') renderSectorDashboardCharts(dashboardPeriodFilter); if (viewId === 'history-view') { populateFilters(); renderHistory(); } if (viewId === 'trash-view') { renderTrash(); } if (viewId === 'sectors-view') { const project = projects.find(p => p.id === currentProjectId); if (project) { document.getElementById('sectors-project-name').textContent = project.name; renderSectorIndicators(); } } };
        
        const showResults = () => { if (currentProjectId) { switchView('sector-dashboard-view'); } else { switchView('project-dashboard-view'); } };
        
        const filterDashboardCharts = (period) => { dashboardPeriodFilter = period; document.querySelectorAll('.dashboard-filter-btn').forEach(btn => { const btnPeriod = btn.getAttribute('data-period'); btn.classList.toggle('bg-indigo-600', btnPeriod === period); btn.classList.toggle('text-white', btnPeriod === period); btn.classList.toggle('bg-white', btnPeriod !== period); btn.classList.toggle('text-gray-700', btnPeriod !== period); }); renderProjectDashboardCharts(period); };
        
        const filterSectorDashboardCharts = (period) => { dashboardPeriodFilter = period; document.querySelectorAll('.sector-dashboard-filter-btn').forEach(btn => { const btnPeriod = btn.getAttribute('data-period'); btn.classList.toggle('bg-indigo-600', btnPeriod === period); btn.classList.toggle('text-white', btnPeriod === period); btn.classList.toggle('bg-white', btnPeriod !== period); btn.classList.toggle('text-gray-700', btnPeriod !== period); }); renderSectorDashboardCharts(period); };
        
        const filterDashboardView = (mode) => { projectDashboardViewMode = mode; document.querySelectorAll('.dashboard-view-btn').forEach(btn => { const btnView = btn.getAttribute('data-view'); btn.classList.toggle('bg-indigo-600', btnView === mode); btn.classList.toggle('text-white', btnView === mode); btn.classList.toggle('bg-white', btnView !== mode); btn.classList.toggle('text-gray-700', btnView !== mode); }); renderProjectDashboardCharts(dashboardPeriodFilter); };
        
        const filterSectorView = (mode) => { sectorDashboardViewMode = mode; document.querySelectorAll('.sector-view-btn').forEach(btn => { const btnView = btn.getAttribute('data-view'); btn.classList.toggle('bg-indigo-600', btnView === mode); btn.classList.toggle('text-white', btnView === mode); btn.classList.toggle('bg-white', btnView !== mode); btn.classList.toggle('text-gray-700', btnView !== mode); }); renderSectorDashboardCharts(dashboardPeriodFilter); };
        
        const filterHistoryPeriod = (period) => { historyFilters.period = period; document.querySelectorAll('.history-filter-btn.period-btn').forEach(btn => { const btnPeriod = btn.getAttribute('data-period'); btn.classList.toggle('bg-indigo-600', btnPeriod === period); btn.classList.toggle('text-white', btnPeriod === period); btn.classList.toggle('bg-white', btnPeriod !== period); btn.classList.toggle('text-gray-700', btnPeriod !== period); }); renderHistory(); };
        
        const populateFilters = () => { const sectorSelect = document.getElementById('sector-filter'); sectorSelect.innerHTML = '<option value="all">Todos os Setores</option>'; Object.keys(subsectorsBySector).filter(s => s !== 'all').forEach(sector => { sectorSelect.innerHTML += `<option value="${sector}">${sector}</option>`; }); sectorSelect.value = historyFilters.sector; updateSubsectorFilter(); };
        
        const updateSubsectorFilter = () => { const sector = document.getElementById('sector-filter').value; const subsectorSelect = document.getElementById('subsector-filter'); subsectorSelect.innerHTML = ''; (subsectorsBySector[sector] || []).forEach(sub => { const value = sub.toLowerCase().includes('todos') ? 'all' : sub; subsectorSelect.innerHTML += `<option value="${value}">${sub}</option>`; }); subsectorSelect.value = historyFilters.subsector; };
        
        async function moveItemToTrash(event, type, id) { if (event) event.stopPropagation(); if (!userId) return; const appId = typeof __app_id != "undefined" ? __app_id : "default-app-id"; const collectionName = type === 'project' ? 'projects' : 'sources'; const docRef = doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, id); try { await updateDoc(docRef, { deleted: true }); } catch (error) { console.error(`Erro ao mover ${type} para a lixeira:`, error); } }
        
        async function restoreItem(type, id) { if (!userId) return; const appId = typeof __app_id != "undefined" ? __app_id : "default-app-id"; const collectionName = type === 'project' ? 'projects' : 'sources'; const docRef = doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, id); try { await updateDoc(docRef, { deleted: false }); } catch (error) { console.error(`Erro ao restaurar ${type}:`, error); } }
        
        function confirmDeletePermanently(type, id) { const item = type === 'project' ? projects.find(p => p.id === id) : sources.find(s => s.id === id); if (!item) return; if (confirm(`EXCLUIR PERMANENTEMENTE "${item.name}"? Esta ação é irreversível.`)) { deleteItemPermanently(type, id); } }
        
        async function deleteItemPermanently(type, id) { if (!userId) return; const appId = typeof __app_id != "undefined" ? __app_id : "default-app-id"; const collectionName = type === 'project' ? 'projects' : 'sources'; const docRef = doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, id); try { await deleteDoc(docRef); } catch (error) { console.error(`Erro ao excluir ${type} permanentemente:`, error); } }
        
        function confirmClearTrash() { if (confirm("Tem certeza que deseja esvaziar a lixeira? Todos os itens serão excluídos permanentemente.")) { clearTrash(); } }
        
        async function clearTrash() { if (!userId) return; const appId = typeof __app_id != "undefined" ? __app_id : "default-app-id"; const batch = writeBatch(db); projects.filter(p => p.deleted).forEach(p => { const docRef = doc(db, `/artifacts/${appId}/users/${userId}/projects`, p.id); batch.delete(docRef); }); sources.filter(s => s.deleted).forEach(s => { const docRef = doc(db, `/artifacts/${appId}/users/${userId}/sources`, s.id); batch.delete(docRef); }); try { await batch.commit(); } catch (error) { console.error("Erro ao esvaziar a lixeira:", error); } }
        
        const renderAll = () => { renderTotalBalance(); renderProjects(); renderInvestmentSources(); if (currentProjectId) { renderSectorIndicators(); } };
        
        const renderHistory = () => { const list = document.getElementById('history-list'); if (!list) return; list.innerHTML = ''; let allTransactions = []; projects.filter(p => !p.deleted).forEach(p => { (p.transactions || []).forEach(t => { allTransactions.push({ ...t, projectName: p.name }); }); }); let filteredTransactions = allTransactions.filter(t => isDateInPeriod(t.date, historyFilters.period)); if (historyFilters.sector !== 'all') { filteredTransactions = filteredTransactions.filter(t => t.sector === historyFilters.sector); } if (historyFilters.subsector !== 'all') { filteredTransactions = filteredTransactions.filter(t => t.subSector === historyFilters.subsector); } filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)); if (filteredTransactions.length === 0) { list.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center col-span-full">Nenhuma operação encontrada.</p>'; return; } filteredTransactions.forEach(t => { const item = document.createElement('div'); const isRevenue = t.type === 'revenue'; item.className = `history-item ${isRevenue ? "history-item-revenue" : "history-item-cost"}`; item.innerHTML = `<div class="flex-grow pr-4"><p class="font-bold">${t.description}</p><p class="text-sm text-gray-500 dark:text-gray-400">${t.projectName} - ${new Date(t.date).toLocaleDateString("pt-BR")}</p><p class="text-xs text-gray-400 dark:text-gray-500">${t.sector} / ${t.subSector}</p></div><p class="font-bold text-lg whitespace-nowrap ${isRevenue ? "text-green-600" : "text-red-600"}">${isRevenue ? "+" : "-"} ${formatCurrency(t.amount)}</p>`; list.appendChild(item); }); };
        
        const renderTrash = () => { const deletedProjectsList = document.getElementById('deleted-projects-list'); const deletedSourcesList = document.getElementById('deleted-sources-list'); deletedProjectsList.innerHTML = ''; deletedSourcesList.innerHTML = ''; const deletedProjects = projects.filter(p => p.deleted); const deletedSources = sources.filter(s => s.deleted); if (deletedProjects.length === 0) { deletedProjectsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Nenhum projeto na lixeira.</p>'; } else { deletedProjects.forEach(p => { const item = document.createElement('div'); item.className = 'trash-item'; item.innerHTML = `<div class="flex-grow"><p class="font-bold">${p.name}</p></div><div class="flex gap-2"><button onclick="restoreItem('project', '${p.id}')" class="text-blue-500 hover:text-blue-700">Restaurar</button><button onclick="confirmDeletePermanently('project', '${p.id}')" class="text-red-500 hover:text-red-700">Excluir</button></div>`; deletedProjectsList.appendChild(item); }); } if (deletedSources.length === 0) { deletedSourcesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Nenhuma fonte na lixeira.</p>'; } else { deletedSources.forEach(s => { const item = document.createElement('div'); item.className = 'trash-item'; item.innerHTML = `<div class="flex-grow"><p class="font-bold">${s.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">${s.type}</p></div><div class="flex gap-2"><button onclick="restoreItem('source', '${s.id}')" class="text-blue-500 hover:text-blue-700">Restaurar</button><button onclick="confirmDeletePermanently('source', '${s.id}')" class="text-red-500 hover:text-red-700">Excluir</button></div>`; deletedSourcesList.appendChild(item); }); } };

        document.addEventListener('DOMContentLoaded', () => {
            // --- PROFILE MENU ---
            document.getElementById('profile-button').addEventListener('click', () => { document.getElementById('profile-menu').classList.toggle('hidden') });
            document.addEventListener('click', e => {
                const menu = document.getElementById('profile-menu');
                const button = document.getElementById('profile-button');
                if (!menu.classList.contains('hidden') && !button.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            // --- FORM SUBMISSIONS ---
            document.getElementById('project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                const projectName = e.target.elements['project-name'].value;
                if (!projectName) return;
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const projectsCollectionPath = `/artifacts/${appId}/users/${userId}/projects`;
                
                try {
                    await addDoc(collection(db, projectsCollectionPath), { name: projectName, transactions: [], deleted: false });
                    closeModal('project-modal');
                    e.target.reset();
                } catch (error) { console.error("Erro ao criar projeto:", error); }
            });

            // Add other form listeners here...
             document.getElementById('investment-action-type').addEventListener('change', updateInvestmentFormUI);

            // Listener para o formulário de Investimento
            document.getElementById('investment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const actionType = form.elements['investment-action-type'].value;
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !userId) return;
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (actionType === 'source') {
                    const name = form.elements['inv-source-name'].value;
                    const type = form.elements['inv-source-type'].value;
                    const balance = parseFloat(form.elements['inv-source-balance'].value);
                    if (!name || !type || isNaN(balance)) return;

                    const sourcesCollectionPath = `/artifacts/${appId}/users/${userId}/sources`;
                    const newSourceRef = await addDoc(collection(db, sourcesCollectionPath), { name, type, balance, deleted: false });

                    const projectDocRef = doc(db, `/artifacts/${appId}/users/${userId}/projects`, project.id);
                    await updateDoc(projectDocRef, {
                        transactions: arrayUnion({
                            type: 'revenue',
                            description: `Nova Fonte: ${name}`,
                            amount: balance,
                            sector: 'Financeiro',
                            subSector: 'Investimento',
                            sourceId: newSourceRef.id,
                            date: new Date().toISOString().split('T')[0]
                        })
                    });
                } else { // 'cost'
                    const sourceId = form.elements['inv-cost-source'].value;
                    const source = sources.find(s => s.id === sourceId);
                    if (!sourceId || !source) return;

                    const amount = parseFloat(form.elements['inv-cost-amount'].value);
                    const newBalance = source.balance - amount;
                    
                    const sourceDocRef = doc(db, `/artifacts/${appId}/users/${userId}/sources`, sourceId);
                    await updateDoc(sourceDocRef, { balance: newBalance });
                    
                    const projectDocRef = doc(db, `/artifacts/${appId}/users/${userId}/projects`, project.id);
                    await updateDoc(projectDocRef, {
                        transactions: arrayUnion({
                            type: 'cost',
                            description: form.elements['inv-cost-description'].value,
                            amount: amount,
                            sector: 'Financeiro',
                            subSector: 'Investimento',
                            sourceId: sourceId,
                            date: form.elements['inv-cost-date'].value
                        })
                    });
                }
                closeModal('investment-modal');
            });

            // Listener para o formulário de Transações Padrão
            document.getElementById('transaction-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !userId) return console.error('Projeto inválido ou usuário não logado.');

                const sourceId = form.elements['transaction-source'].value;
                const source = sources.find(s => s.id === sourceId);
                if (!source) return console.error('Fonte de Recurso inválida.');

                const amount = parseFloat(form.elements['transaction-amount'].value);
                const type = form.elements['transaction-type'].value;
                const newBalance = source.balance + (type === 'revenue' ? amount : -amount);
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const sourceDocRef = doc(db, `/artifacts/${appId}/users/${userId}/sources`, sourceId);
                await updateDoc(sourceDocRef, { balance: newBalance });

                const projectDocRef = doc(db, `/artifacts/${appId}/users/${userId}/projects`, project.id);
                await updateDoc(projectDocRef, {
                    transactions: arrayUnion({
                        type: type,
                        description: form.elements['transaction-description'].value,
                        amount: amount,
                        sector: form.elements['transaction-sector'].value,
                        subSector: form.elements['transaction-subsector'].value,
                        sourceId: sourceId,
                        date: form.elements['transaction-date'].value
                    })
                });

                closeModal('transaction-modal');
            });

            // --- FILTER LISTENERS ---
            document.getElementById('sector-filter').addEventListener('change', (e) => {
                historyFilters.sector = e.target.value;
                historyFilters.subsector = 'all'; 
                updateSubsectorFilter();
                renderHistory();
            });
            document.getElementById('subsector-filter').addEventListener('change', (e) => {
                historyFilters.subsector = e.target.value;
                renderHistory();
            });
        });

        window.switchAuthView = switchAuthView;
        window.handleLogout = handleLogout;
        window.handleAnonymousLogin = handleAnonymousLogin;
        window.switchView=switchView;window.openModal=openModal;window.closeModal=closeModal;window.closeModalOnOutsideClick=closeModalOnOutsideClick;window.openTransactionModal=openTransactionModal;window.openInvestmentModal=openInvestmentModal;window.showResults=showResults;window.filterDashboardCharts=filterDashboardCharts;window.filterDashboardView=filterDashboardView;window.filterSectorDashboardCharts=filterSectorDashboardCharts;window.filterSectorView=filterSectorView;window.filterHistoryPeriod=filterHistoryPeriod;window.moveItemToTrash=moveItemToTrash;window.restoreItem=restoreItem;window.confirmDeletePermanently=confirmDeletePermanently;window.confirmClearTrash=confirmClearTrash;
    </script>
</body>
</html>

